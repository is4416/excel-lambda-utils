= LAMBDA(StartDate, EndDate, MinTime, MaxTime, LET(
  StartTime, MOD(StartDate, 1),
  EndTime  , MOD(EndDate, 1),
  MinT     , MOD(MinTime, 1),
  MaxT     , MOD(MaxTime, 1),
  Buf      , INT(EndDate) - INT(StartDate),
  Days     , IF(Buf > 0, Buf, IF(StartTime >= EndTime, 1, 0)),

  TimeOfOneDay, MaxT - MinT + IF(MinT < MaxT, 0, 1),
  TimeOfDays  , (Days - 1) * TimeOfOneDay,

  FirstDayUpperLimit, IF(Days > 0, 1, MaxT),
  FirstDayUpperTime , IF(Days > 0, 1, EndTime),
  FirstDayUpper     , IF(FirstDayUpperLimit < FirstDayUpperTime,
    FirstDayUpperLimit, FirstDayUpperTime
  ),
  FirstDayLower , IF(StartTime < MinT, MinT, StartTime),
  TimeOfFirstDay, IF(FirstDayLower < FirstDayUpper,
    FirstDayUpper - FirstDayLower,
    0
  ),

  LastDayLowerLimit, IF(Days > 0, 0, MinT),
  LastDayLowerTime , IF(StartTime < EndTime, StartTime, 0),
  LastDayLower     , IF(LastDayLowerLimit < LastDayLowerTime,
    LastDayLowerTime,
    LastDayLowerLimit
  ),
  LastDayUpper , IF(MaxT < EndTime, MaxT, EndTime),
  TimeOfLastDay, IF(LastDayLower < LastDayUpper,
    LastDayUpper - LastDayLower,
    0
  ),

  TimeOfFirstDay + TimeOfDays + TimeOfLastDay
))
